API Authentication Setup

API 101
 - async requests, not just url html pages
 - we can get text, image, video etc
 - POST , GET - update, get, set data also
 - API - server opens some door to perform some actions
 - Endpoints - are individual functionalities we can communicate
 - API's can be backend also, meaning server requesting a server

API Endpoint
 - next.js - allows to create a dedicated server
 - api/ - new folder inside the app folder in next.js
 - auth/ - another folder inside the api folder
 - route.js - whatever file is named route.js will be an endpoint
 - export function GET() {} - we allow a request with GET method
 - return Reponse.json({ message: "API up and running" });
 - we give back a response in json format, with the contents inside
 - Response has different methods, such as reply with error, redirect etc
 - view errors / responses inside the console when running npm run dev
 - In browser localhost:3000/api/auth, shows the status code "200 OK"
 - Example - count the users with db request, and show "133 users signed-up"

Comments on implementation details
 - app/api/auth/route.js - prepare the POST login method
 - components/button/ButtonLogin.js - prepare the frontend

Auth.js
 - npm install next-auth@beta
 - create new file - @/libs/auth.js
 - import NextAuth from "next-auth";
 - const config = {  providers: [] };
 - export const { handlers,  signIn,  signOut,  auth } = NextAuth(config);
 - npx auth secret - creates the AUTH_SECRET inside .env.local
 - remove the route.js - create folder [...nextauth] - matches all requests
 - route.js - import { handlers } from "@/libs/auth";
 - export const { GET, POST } = handlers;
 - localhost:3000/api/auth/signin - new empty page

User authentication 101
 - client - /sigin html - POST auth/sigin - check db/provider - send session
 - email/password - magic link - google oauth (variations of authentication)
 - session - expiry date (30 days) / verification encryption / set-cookie
 - cookie - persistent on client, send on every request to validate auth
 - redirect - /dashboard (every request / api endpoint / send the cookie)

Cookie
 - small piece of data - send by web-server to internet browser
 - store the data on computer / phone - used everywhere to track
 - user preferences / attribution tracking / analytics / authentication
 - chrome dev tools - Application - Cookies - Domain - Name/Value/Expires
 - eg. insigh.to - __Host-next-auth.csrf-token - 39262b848cc0551ae69184f41ffe8ab041ec700da7a7e1ac0a6d645a0b1ac9e0%7C3bb3ac735d91b10dc40fae2d0c04165665ff649df9ebecd1df0f008adc86961c

Database connection
 - Set-up database - to store users / sessions
 - Set-up providers - log-in with google oauth
 - npm install @auth/mongodb-adapter
 - add it to auth.js - import the adapter and clientPromise
 - import { MongoDBAdapter } from "@auth/mongodb-adapter";
 - import clientPromise from "@/libs/mongo";
 - { adapter: MongoDBAdapter(clientPromise) }

Emails
 - 2 types - transactional / marketing emails
 - magic links - they enter their email, we send them a link
 - resend - get started - go to the domain names
 - domains - enter the subdomain + region "us-east-1" (same as vercel)
 - subdomains - are used to prevent ruining domain reputation when hacked

Namecheap
 - Advanced DNS - Custom MX - set-up the sending / receiving (tudorcrisan.dev)
 - DKMIM / SPF / DMARC - for email providers so we don't end-up in spam

Resend
 - API Keys - Create API Key - Name: TudorCrisan.dev - Full Access - All domains
 - .env.local - RESEND_KEY - add the key to send / receive emails through API
 - don't share with anyone so they can send emails on your behalf
 - https://resend.com/docs/send-with-nodejs / npm install resend
 - View emails received - https://resend.com/emails/receiving

Auth.js
 - Providers - in the documentation we can find providers, based on niche
 - https://authjs.dev/getting-started/providers/twitter
 - one social provider / email based provider - in case they lose access
 - magic links over email/password - it's a less headache for development
 - import Resend from "next-auth/providers/resend"
 - providers: [Resend({apiKey, from, name})]
 - check compass - db - users - sessions
 - email url - http://localhost:3000/api/auth/callback/resend?callbackUrl=http%3A%2F%2Flocalhost%3A3000&amp;token=c9aacd878d2939b33e2cc9eb7f4466ff8579704a0b86146f2c62be0c392a1a6b&amp;email=c7336229%40gmail.com

Google OAuth
 - https://console.cloud.google.com/ - go to projects on top left
 - "New project" - enter the project name "LoyalBoards" - "no organization"
 - Left menu - API & Services - Credentials - click on right "Configure consent screen"
 - Get Started - App name - "LoyalBoards" - support email - click next - select "External"
 - Enter email for google to contact you - select branding, put the app logo, the domain
 - /tos/privacy and /tos/terms - "Add / remove scopes" - userinfo:email | userinfo.profile
 - Scroll bottom - "update" - scroll bottom "save" then continue
 - Audience - test users (add yourself as a test user) c7336229@gmail.com - t7790802@gmail.com
 - Clients - Web application - Web client 1 - URI - localhost:3000 / domain
 - Redirect URI - https://localhost:3000/api/auth/callback/google (and same for domain)
 - Download JSON - store it inside "sensitive" folder in shipfast
 - /api/auth/sigin - sign-in with google / select a new email / and authorize
 - Compass - new collection called "accounts" - new accounts go there, and on "users" it's set 
 - "name" | "email" | "image" - all great for dashboard / profile and transactional emails
 - REMEMBER - to "Publish app" https://console.cloud.google.com/auth/audience?project=loyalboards

Sessions
 - handlers - api/auth/[...nextauth] | signin | signOut | auth (check valid session)
 - import auth from "@/libs/auth"; const session = await auth();
 - user / session - in one object from auth() - create a WrapperAuth.server and WrapperAuth.client
 - { isLoggedIn } = useAuth() - we prepare all of this in WrapperAuth.server
 - { name, email, initials } - we set these as well - on incognito it they will not show-up














 






 
